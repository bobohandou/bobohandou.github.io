<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js è§†å¬ç²’å­ç³»ç»Ÿ</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', sans-serif;
        }

        canvas {
            display: block;
        }

        .input_video {
            display: none;
        }

        /* UI é¢æ¿ */
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 20px;
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            z-index: 10;
            width: 240px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s;
        }

        h2 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #888;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px;
        }

        .section {
            margin-bottom: 20px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .grid-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #ddd;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

            button:hover {
                background: rgba(255, 255, 255, 0.25);
                color: white;
                transform: translateY(-1px);
            }

            button.active {
                background: #4f8aff;
                color: white;
                box-shadow: 0 0 12px rgba(79, 138, 255, 0.5);
                font-weight: bold;
            }

        /* éŸ³ä¹æ§åˆ¶åŒº */
        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

            .file-upload input[type=file] {
                font-size: 100px;
                position: absolute;
                left: 0;
                top: 0;
                opacity: 0;
                cursor: pointer;
            }

        .file-btn {
            background: #ff4757;
            width: 100%;
            display: block;
            text-align: center;
            color: white;
            padding: 8px 0;
            border-radius: 6px;
            font-size: 12px;
        }

        #mic-btn {
            background: #2ed573;
            color: white;
        }

        /* é¢œè‰²ä¸çŠ¶æ€ */
        .control-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 30px;
            height: 20px;
            cursor: pointer;
            background: none;
        }

        #status-bar {
            margin-top: 15px;
            font-size: 11px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 4px;
        }

        .led {
            width: 6px;
            height: 6px;
            background: #333;
            border-radius: 50%;
            box-shadow: inset 0 0 2px black;
        }

            .led.on {
                background: #00ff00;
                box-shadow: 0 0 5px #00ff00;
            }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            text-align: center;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 20;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <video class="input_video"></video>

    <div id="ui-container">
        <div class="section">
            <h2>ç²’å­å½¢æ€</h2>
            <div class="grid-buttons">
                <button onclick="morphTo('heart', event)" class="active">çˆ±å¿ƒ</button>
                <button onclick="morphTo('saturn', event)"class="active">åœŸæ˜Ÿ</button>
                <button onclick="morphTo('flower', event)"class="active">ç”Ÿå‘½ä¹‹èŠ±</button>
                <button onclick="morphTo('buddha', event)"class="active">æ‰“å</button>
                <button onclick="morphTo('dna', event)"class="active">DNAèºæ—‹</button>
                <button onclick="morphTo('sphere', event)"class="active">çƒä½“</button>
            </div>
        </div>

        <div class="section">
            <h2>éŸ³ä¹å¾‹åŠ¨</h2>
            <div class="audio-controls">
                <button id="mic-btn" onclick="setupAudio('mic')">ğŸ¤ å¼€å¯éº¦å…‹é£å¾‹åŠ¨</button>
                <div class="file-upload">
                    <div class="file-btn">ğŸµ ä¸Šä¼  MP3 éŸ³ä¹</div>
                    <input type="file" id="audio-file" accept="audio/*" onchange="setupAudio('file', this)">
                </div>
            </div>
            <div class="control-group">
                <span>ç²’å­é¢œè‰²</span>
                <input type="color" id="colorPicker" value="#4f8aff">
            </div>
        </div>

        <div id="status-bar">
            <div class="led" id="cam-led"></div> <span>è§†è§‰: <span id="cam-status">åˆå§‹åŒ–...</span></span>
            <div style="width:10px"></div>
            <div class="led" id="audio-led"></div> <span>éŸ³é¢‘: <span id="audio-status">é™é»˜</span></span>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div>å¯åŠ¨è§†è§‰å¼•æ“...<br><span style="font-size:12px; opacity:0.7">è¯·å…è®¸æ‘„åƒå¤´æƒé™</span></div>
    </div>

    <script>
        // --- 1. Three.js åœºæ™¯æ­å»º ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.002);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 30;

        const renderer = new THREE.WebGLRenderer({ antialias: true }); // å»æ‰alphaä»¥è·å¾—æ›´é»‘çš„èƒŒæ™¯
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- 2. å¢å¼ºå‹ç²’å­ç³»ç»Ÿ ---
        const particleCount = 20000; // å¢åŠ ç²’å­æ•°é‡
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3);
        const originalPositions = new Float32Array(particleCount * 3); // ç”¨äºå¤ä½
        const targetPositions = new Float32Array(particleCount * 3);
        const randoms = new Float32Array(particleCount); // ç»™æ¯ä¸ªç²’å­ä¸€ä¸ªéšæœºå±æ€§ç”¨äºé—ªçƒ

        for(let i = 0; i < particleCount; i++) {
            positions[i*3] = (Math.random() - 0.5) * 100;
            positions[i*3+1] = (Math.random() - 0.5) * 100;
            positions[i*3+2] = (Math.random() - 0.5) * 100;
            randoms[i] = Math.random();
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('aRandom', new THREE.BufferAttribute(randoms, 1));

        const material = new THREE.PointsMaterial({
            color: 0x4f8aff,
            size: 0.12,
            sizeAttenuation: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            transparent: true,
            opacity: 0.9
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        // --- 3. å‡ ä½•å½¢çŠ¶ç”Ÿæˆç®—æ³• ---
        function getPoint(r, type) {
            // é€šç”¨çƒé¢ç‚¹ç”Ÿæˆ
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos((Math.random() * 2) - 1);
            return {
                x: r * Math.sin(phi) * Math.cos(theta),
                y: r * Math.sin(phi) * Math.sin(theta),
                z: r * Math.cos(phi)
            };
        }

        const Shapes = {
            sphere: (i) => { const p = getPoint(10); return [p.x, p.y, p.z]; },
            heart: (i) => {
                const t = Math.random() * Math.PI * 2;
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                const z = (Math.random() - 0.5) * 5;
                return [x * 0.5, y * 0.5, z];
            },
            saturn: (i) => {
                // 30% æ˜Ÿçƒï¼Œ70% æ˜Ÿç¯
                if (i < particleCount * 0.3) {
                    const p = getPoint(6); return [p.x, p.y, p.z];
                } else {
                    const ang = Math.random() * Math.PI * 2;
                    const r = 8 + Math.random() * 8;
                    const x = Math.cos(ang) * r;
                    const z = Math.sin(ang) * r;
                    // å€¾æ–œ
                    const tilt = 0.5;
                    return [x, (Math.random()-0.5)*0.5 + x * Math.sin(tilt), z * Math.cos(tilt)];
                }
            },
            flower: (i) => {
                const phi = Math.PI * (3 - Math.sqrt(5));
                const y = 1 - (i / (particleCount - 1)) * 2;
                const r = Math.sqrt(1 - y * y);
                const theta = phi * i;
                const scale = 12;
                return [Math.cos(theta) * r * scale, y * scale * 0.2, Math.sin(theta) * r * scale];
            },
            dna: (i) => {
                const t = (i / particleCount) * 20 * Math.PI; // é«˜åº¦
                const radius = 5;
                const x = Math.cos(t) * radius;
                const z = Math.sin(t) * radius;
                const y = (i / particleCount) * 40 - 20;

                // åŒèºæ—‹
                const offset = i % 2 === 0 ? 0 : Math.PI;
                return [Math.cos(t + offset) * radius, y, Math.sin(t + offset) * radius];
            },
            buddha: (i) => {
                // ç®€å•çš„åå§¿æŠ½è±¡
                const r = Math.random();
                if(r < 0.2) { // å¤´
                   const p = getPoint(2.5); return [p.x, p.y + 6, p.z];
                } else if (r < 0.6) { // èº«
                   const h = (Math.random() - 0.5) * 6;
                   const rad = 3.5 - (h+3)*0.3;
                   const ang = Math.random()*Math.PI*2;
                   return [Math.cos(ang)*rad, h+1, Math.sin(ang)*rad];
                } else { // è…¿
                   const p = getPoint(6); return [p.x, p.y * 0.4 - 3, p.z];
                }
            }
        };

window.morphTo = function(type, e) {
    if(!Shapes[type]) return;

    // ... ç²’å­å½¢æ€åˆ‡æ¢ä»£ç  ...

    // UIæ›´æ–° (ä½¿ç”¨ä¼ é€’è¿›æ¥çš„äº‹ä»¶å¯¹è±¡ e)
    document.querySelectorAll('.grid-buttons button').forEach(b => b.classList.remove('active'));

    // ç¡®ä¿ e å­˜åœ¨ï¼Œä»¥é˜²æ­¢åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ morphTo æ—¶çš„æ½œåœ¨é”™è¯¯
    if (e && e.target) {
    // ç¡®ä¿ UI é€»è¾‘ä½¿ç”¨ 'e' (event object)
    if (e) { 
        document.querySelectorAll('.grid-buttons button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active'); 
    } else {
         // å¦‚æœæ˜¯é€šè¿‡ä»£ç è°ƒç”¨ï¼ˆä¾‹å¦‚é»˜è®¤è°ƒç”¨ï¼‰ï¼Œåˆ™ä¸æ‰§è¡ŒUIæ›´æ–°ï¼Œæˆ–æ‰‹åŠ¨æ‰¾åˆ°æŒ‰é’®
         console.warn("Event object missing for UI update.");
    }
    
    // ğŸ’¥ æ£€æŸ¥è¿™ä¸ªå…³é”®å¾ªç¯ ğŸ’¥
    if(!Shapes[type]) return; 
    
    for(let i=0; i<particleCount; i++) {
        // è°ƒç”¨æ­£ç¡®çš„å½¢çŠ¶å‡½æ•°ï¼Œå¹¶è·å– 3D åæ ‡
        const pos = Shapes[type](i); 

        // æ ¸å¿ƒï¼šå°†å½¢çŠ¶åæ ‡å¡«å……åˆ° targetPositions æ•°ç»„ä¸­
        targetPositions[i*3] = pos[0];   // X
        targetPositions[i*3+1] = pos[1]; // Y
        targetPositions[i*3+2] = pos[2]; // Z
    }
    // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦è®¾ç½® geometry.attributes.position.needsUpdate = trueï¼Œ
    // å› ä¸ºè¿™ä¼šåœ¨ animate å¾ªç¯ä¸­æŒç»­æ›´æ–°ã€‚
};

        // --- 4. éŸ³é¢‘åˆ†æç³»ç»Ÿ (Audio API) ---
        let analyser, dataArray, audioContext;
        let audioAverage = 0; // ç”¨äºé©±åŠ¨ç²’å­è·³åŠ¨

        window.setupAudio = async function(sourceType, element) {
            try {
                if(!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // æ¢å¤ä¸Šä¸‹æ–‡ï¼ˆæµè§ˆå™¨ç­–ç•¥ï¼‰
                if(audioContext.state === 'suspended') await audioContext.resume();

                // æ–­å¼€ä¹‹å‰çš„è¿æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
                if(analyser) analyser.disconnect();

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512; // é‡‡æ ·ç²¾åº¦
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                let source;

                if (sourceType === 'mic') {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    source = audioContext.createMediaStreamSource(stream);
                    document.getElementById('audio-status').innerText = "éº¦å…‹é£ç›‘å¬ä¸­";
                } else if (sourceType === 'file') {
                    const file = element.files[0];
                    if(!file) return;
                    const fileUrl = URL.createObjectURL(file);
                    const audio = new Audio(fileUrl);
                    audio.play();
                    source = audioContext.createMediaElementSource(audio);
                    source.connect(audioContext.destination); // è¿æ¥åˆ°æ‰¬å£°å™¨å¬è§å£°éŸ³
                    document.getElementById('audio-status').innerText = "æ’­æ”¾éŸ³ä¹ä¸­: " + file.name.substring(0,10) + "...";
                }

                source.connect(analyser);
                document.getElementById('audio-led').classList.add('on');

            } catch (err) {
                console.error(err);
                alert("éŸ³é¢‘å¯åŠ¨å¤±è´¥: " + err.message);
            }
        };

        // --- 5. MediaPipe æ‰‹åŠ¿è¯†åˆ« ---
        let handScale = 1.0;
        let smoothedHandScale = 1.0;

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        hands.onResults(results => {
            document.getElementById('loader').style.opacity = 0;
            document.getElementById('cam-led').classList.add('on');
            document.getElementById('cam-status').innerText = "è¿½è¸ªä¸­";

            if (results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const d = Math.sqrt(Math.pow(lm[4].x - lm[8].x, 2) + Math.pow(lm[4].y - lm[8].y, 2));
                // æ˜ å°„æ‰‹åŠ¿è·ç¦»åˆ°ç¼©æ”¾: 0.02->0.5, 0.2->2.0
                handScale = 0.5 + (d * 7);
            } else {
                // æ— æ‰‹åŠ¿æ—¶ç¼“æ…¢å¤åŸ
                handScale = 1.0;
            }
        });

        const video = document.getElementsByClassName('input_video')[0];
        const cameraUtils = new Camera(video, {
            onFrame: async () => await hands.send({image: video}),
            width: 640, height: 480
        });
        cameraUtils.start();

        // --- 6. æ¸²æŸ“å¾ªç¯ ---
        const clock = new THREE.Clock();
        document.getElementById('colorPicker').addEventListener('input', (e) => material.color.set(e.target.value));

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            // A. å¤„ç†éŸ³é¢‘æ•°æ®
            let beatPulse = 1.0;
            if(analyser) {
                analyser.getByteFrequencyData(dataArray);
                // è®¡ç®—ä½é¢‘å¹³å‡å€¼ (Bass)
                let sum = 0;
                // å–å‰50ä¸ªé¢‘æ®µä½œä¸ºä½éŸ³åŒº
                for(let i = 0; i < 50; i++) sum += dataArray[i];
                audioAverage = sum / 50;

                // æ˜ å°„éŸ³é¢‘å¼ºåº¦åˆ°ç¼©æ”¾è„‰å†² (0 ~ 255 -> 1.0 ~ 1.5)
                beatPulse = 1.0 + (audioAverage / 255) * 0.6;
            }

            // B. ç»“åˆæ‰‹åŠ¿ä¸éŸ³ä¹
            // æœ€ç»ˆç¼©æ”¾ = æ‰‹åŠ¿ç¼©æ”¾ * éŸ³ä¹è„‰å†²
            // ä½¿ç”¨ lerp å¹³æ»‘æ‰‹åŠ¿å˜åŒ–
            smoothedHandScale += (handScale - smoothedHandScale) * 0.1;
            const finalScale = smoothedHandScale * beatPulse;
            particles.scale.setScalar(finalScale);

            // C. ç²’å­åŠ¨æ€æ›´æ–°
            const pos = geometry.attributes.position.array;
            for(let i=0; i<particleCount; i++) {
                const i3 = i*3;

                // ç§»åŠ¨å‘ç›®æ ‡å½¢çŠ¶
                pos[i3] += (targetPositions[i3] - pos[i3]) * 0.05;
                pos[i3+1] += (targetPositions[i3+1] - pos[i3+1]) * 0.05;
                pos[i3+2] += (targetPositions[i3+2] - pos[i3+2]) * 0.05;

                // éŸ³ä¹å¸¦æ¥çš„é«˜é¢‘é¢¤åŠ¨æ•ˆæœ
                if(audioAverage > 50) {
                    const noise = (Math.random() - 0.5) * (audioAverage / 500);
                    pos[i3] += noise;
                    pos[i3+1] += noise;
                    pos[i3+2] += noise;
                }
            }

            // æ—‹è½¬åœºæ™¯
            scene.rotation.y = time * 0.05;
            // éŸ³ä¹è¶Šå¼ºï¼Œæ—‹è½¬è¶Šå¿«ä¸€ç‚¹
            scene.rotation.z = Math.sin(time * 0.1) * 0.1 * beatPulse;

            geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>

</html>
